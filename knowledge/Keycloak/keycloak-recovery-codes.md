---
title: Recovery Authentication Codes
domain: Keycloak
type: howto
status: draft
tags: [keycloak, recovery-codes, 2fa, otp, backup-authentication, authentication]
created: 2026-01-29
related: [[keycloak-otp-totp-authentication]], [[keycloak-authenticator-spi-walkthrough]], [[keycloak-required-action-spi]]
---

# Recovery Authentication Codes

## Overview

Recovery codes are a Second Factor Authentication (2FA) backup method in Keycloak (available since version 26.3.0). They provide access when your primary 2FA device (phone, YubiKey, etc.) is unavailable.

### What Are Recovery Codes?

- **Twelve sequential one-time passwords** auto-generated by Keycloak
- Used as backup when OTP or WebAuthn device is unavailable
- Codes are used **in order** - each login consumes the next code
- Once used, a code is removed and cannot be reused

### Use Cases

| Scenario | Solution |
|----------|----------|
| Phone battery dead | Use recovery code to login |
| Lost authenticator app | Use recovery code to regain access |
| Broken YubiKey | Use recovery code as backup |
| Cannot receive SMS | Use recovery code to login |

## Configuration

### Enable in Authentication Flow

**Default Browser Flow Configuration:**

1. Navigate to **Authentication** → **Flows**
2. Select the **browser** flow
3. Expand **Browser - Conditional 2FA** step
4. Find **Recovery Authentication Code Form** (default: Disabled)
5. Change to **Alternative**

```
Browser Flow
├── Browser - Conditional 2FA
│   ├── OTP Form (Alternative)
│   └── Recovery Authentication Code Form (Alternative) ← Enable this
```

With both set to **Alternative**, users can choose either method during login.

### Configure OTP Integration

Enable recovery codes during OTP setup:

1. Navigate to **Authentication** → **Required Actions**
2. Edit **Configure OTP** required action
3. Enable **Recovery Authentication Codes** switch
4. This forces users to set up recovery codes when configuring OTP

## User Setup

### Admin-Initiated Setup

Assign to specific users:

1. Navigate to **Users** → Select user
2. **Required Actions** tab
3. Add **Recovery Authentication Codes**
4. User will be prompted on next login

Set as default for all new users:

1. Navigate to **Authentication** → **Required Actions**
2. Edit **Recovery Authentication Codes**
3. Set **Default Action** = ON

### User Self-Service Setup

**Via Account Console:**

1. Navigate to **Account Security** → **Signing in**
2. Find **Recovery authentication codes** section
3. Click **Set up Recovery authentication codes**
4. Keycloak generates 12 codes
5. Copy/save codes in secure location
6. Check **I have saved these codes somewhere safe**
7. Complete setup

**Regenerate Codes:**

Users can regenerate codes anytime via Account Console when codes are running low.

## Login Flow with Recovery Codes

### Standard Login with Recovery Codes

```
┌──────────────────┐
│ Username/Password│
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 2FA Challenge    │
│ (OTP or WebAuthn)│
└────────┬─────────┘
         │
         ▼ (if primary 2FA unavailable)
┌──────────────────┐
│ Try Another Way  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Recovery Code    │
│ (Code #1, #2...) │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Login Success    │
└──────────────────┘
```

### Step-by-Step User Experience

1. **Username/Password**: Enter credentials
2. **OTP Challenge**: Authenticator app code requested
3. **Try Another Way**: Click if phone unavailable
4. **Select Recovery Code**: Choose backup method
5. **Enter Code**: Use next sequential code (#1, #2, etc.)
6. **Complete Login**: Successful authentication

### Code Usage Order

Codes must be used **sequentially**:

```
Generated Codes:
1. AB12-CD34-EF56
2. GH78-IJ90-KL12
3. MN34-OP56-QR78
...
12. YZ12-AB34-CD56

Usage:
Login 1: Requires code #1 (AB12-CD34-EF56)
Login 2: Requires code #2 (GH78-IJ90-KL12)
Login 3: Requires code #3 (MN34-OP56-QR78)
```

Once a code is used, it's **consumed** and cannot be reused.

## Low Code Warning

### Default Warning Threshold

- **Default**: Warn when fewer than 4 codes remain
- User sees warning in Account Console

### Configure Threshold

Edit required action configuration to adjust warning level.

### Regeneration Options

Users can regenerate codes:
- **Manually**: Via Account Console
- **Automatically**: After using last code, setup is presented again

## Advanced Configuration

### Custom Warning Threshold

```java
// Programmatically configure threshold
RecoveryCodeAuthenticatorFactory factory = new RecoveryCodeAuthenticatorFactory();
Map<String, String> config = new HashMap<>();
config.put("warningThreshold", "3"); // Warn at 3 codes remaining
```

### Conditional Recovery Code Usage

Create conditional authenticator for risk-based recovery code usage:

```java
package com.example.keycloak.authenticator;

import org.keycloak.authentication.authenticators.conditional.ConditionalAuthenticator;
import org.keycloak.models.*;

public class RecoveryCodeConditionalAuthenticator implements ConditionalAuthenticator {

    @Override
    public boolean matchCondition(AuthenticatorFlowContext context) {
        UserModel user = context.getUser();
        AuthenticatorModel config = context.getAuthenticatorConfig();

        // Condition: Only allow recovery codes if:
        // 1. User has high-value role
        // 2. This is first login from new location
        // 3. Device not recognized

        boolean hasHighValueRole = user.hasRealmRole("financial-user");
        boolean isNewLocation = isNewLoginLocation(context);
        boolean unknownDevice = isUnknownDevice(context);

        return hasHighValueRole && (isNewLocation || unknownDevice);
    }

    private boolean isNewLoginLocation(AuthenticatorFlowContext context) {
        // Check IP geolocation
        String ip = context.getConnection().getRemoteAddr();
        // ... geolocation logic
        return false;
    }

    private boolean isUnknownDevice(AuthenticatorFlowContext context) {
        // Check user agent / device fingerprint
        return false;
    }

    @Override
    public void action(AuthenticatorFlowContext context) {
        context.success();
    }

    @Override
    public boolean requiresUser() {
        return true;
    }

    @Override
    public void close() {
    }

    public static class Factory implements AuthenticatorFactory {
        public static final String PROVIDER_ID = "conditional-recovery-codes";
        // ... factory implementation
    }
}
```

## Best Practices

### User Communication

- [ ] Inform users about recovery codes during 2FA setup
- [ ] Provide clear instructions on storing codes securely
- [ ] Explain sequential usage (must use codes in order)
- [ ] Document regeneration process

### Security Considerations

- [ ] Treat recovery codes with same security as passwords
- [ ] Store codes offline (password manager, printed copy)
- [ ] Never share or store codes electronically unencrypted
- [ ] Regenerate codes if compromised

### Administration

- [ ] Monitor code usage via audit logs
- [ ] Set appropriate warning threshold
- [ ] Require regeneration after security incident
- [ ] Consider automatic regeneration policies

### User Experience

- [ ] Clear onboarding for code setup
- [ ] Prominent warnings when codes running low
- [ ] Easy regeneration process
- [ ] Accessibility support (screen reader friendly)

## Troubleshooting

### User Cannot See Recovery Code Option

**Check:**
- Recovery Code Form is enabled in browser flow
- Flow is bound to Browser Flow in Bindings
- Required action is assigned to user

**Solution:**
1. Navigate to **Authentication** → **Flows**
2. Select **browser** flow
3. Set **Recovery Authentication Code Form** to **Alternative**
4. Navigate to **Authentication** → **Bindings**
5. Verify **Browser Flow** is set to **browser**

### Codes Not Being Generated

**Check:**
- Required action is properly assigned
- User session is valid
- No conflicting authenticators

**Solution:**
```bash
# Check user required actions via Admin CLI
kcadm.sh get users/$USER_ID/required-actions

# Assign recovery code action
kcadm.sh put users/$USER_ID/required-actions/recovery-authentication-code
```

### User Lost All Recovery Codes

**Solution:**
1. Admin can manually assign required action again
2. User goes through setup process
3. Old codes are invalidated
4. New codes are generated

### Warning Not Showing

**Check:**
- Warning threshold configuration
- Code usage count
- Account Console permissions

**Solution:**
```bash
# Check remaining codes via database
SELECT * FROM credential WHERE type = 'recovery-authentication-code' AND user_id = '$USER_ID';

# Or via Admin API
GET /admin/realms/{realm}/users/{id}/credentials
```

## Monitoring and Auditing

### Audit Events

Keycloak logs recovery code events:

```json
{
  "eventType": "RECOVERY_CODE_USED",
  "userId": "user-id",
  "realmId": "my-realm",
  "clientId": "account-console",
  "ipAddress": "192.168.1.100",
  "timestamp": 1706227200000
}
```

### Metrics

Monitor via Prometheus endpoint:

```
# Recovery code usage
keycloak_recovery_code_generated_total
keycloak_recovery_code_used_total
keycloak_recovery_code_remaining_total

# Failed attempts
keycloak_recovery_code_failed_total
```

## Comparison with Other 2FA Methods

| Feature | Recovery Codes | OTP/TOTP | WebAuthn |
|---------|---------------|----------|----------|
| **Device Required** | No | Yes (phone) | Yes (hardware key) |
| **Offline Access** | Yes | Yes | Yes |
| **One-time Use** | Yes | No (time-based) | Yes (per device) |
| **Setup Difficulty** | Easy | Medium | Medium |
| **Primary Use** | Backup | Daily 2FA | Daily 2FA |
| **Recovery Option** | No | Yes | Yes |

## Integration with Authentication Flows

### Multi-Factor with Recovery

```
Browser Flow
├── Browser - Username Password Form
├── Browser - Conditional 2FA
│   ├── OTP Form (Alternative)
│   ├── WebAuthn Passwordless (Alternative)
│   └── Recovery Authentication Code Form (Alternative)
└── Browser - Finish
```

### Step-up Authentication

Recovery codes can integrate with step-up authentication flows:

```
High-Value Transaction Flow
├── Identify User
├── Re-authenticate
├── Additional Verification
│   ├── OTP (Required)
│   └── Recovery Code (Alternative if OTP unavailable)
└── Complete Transaction
```

## Customization

### Custom Code Generation

Create custom recovery code provider:

```java
package com.example.keycloak.credential;

import org.keycloak.credential.CredentialProvider;
import org.keycloak.credential.CredentialModel;
import org.keycloak.models.KeycloakSession;
import org.keycloak.models.UserModel;

public class CustomRecoveryCodeProvider implements CredentialProvider {

    @Override
    public CredentialModel createCredential(KeycloakSession session,
                                           UserModel user) {
        // Generate custom format codes
        List<String> codes = generateCustomCodes();

        CredentialModel credential = new CredentialModel();
        credential.setType("recovery-authentication-code");
        credential.setValue(serializeCodes(codes));
        credential.setCounter(codes.size()); // Remaining count

        return credential;
    }

    private List<String> generateCustomCodes() {
        List<String> codes = new ArrayList<>();
        SecureRandom random = new SecureRandom();

        for (int i = 0; i < 12; i++) {
            // Custom format: 4 groups of 4 characters
            String code = String.format("%04s-%04s-%04s-%04s",
                random.nextInt(10000),
                random.nextInt(10000),
                random.nextInt(10000),
                random.nextInt(10000));
            codes.add(code);
        }

        return codes;
    }

    // ... other methods
}
```

## Related Topics

- [[keycloak-otp-totp-authentication]] - OTP/TOTP configuration
- [[keycloak-authenticator-spi-walkthrough]] - Custom authenticator development
- [[keycloak-required-action-spi]] - Required action SPI
- [[keycloak-webauthn]] - WebAuthn passwordless authentication

## Additional Resources

- [Recovery Codes Blog Post](https://www.keycloak.org/2025/10/recovery-codes)
- [Server Admin Guide - Recovery Codes](https://www.keycloak.org/docs/latest/server_admin/#_recovery-codes)
- [Video: Keycloak Recovery Authentication Codes](https://www.youtube.com/watch?v=example) (Niko Köbler)
