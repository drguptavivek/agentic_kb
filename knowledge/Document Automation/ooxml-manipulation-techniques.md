---
tags:
  - ooxml
  - docx
  - word
  - xml
  - python
  - document-automation
created: 2025-12-25
---

# OOXML Manipulation Techniques

## Overview

OOXML (Office Open XML) is the ZIP-based format used by `.docx` files. Understanding its structure is essential for post-processing documents generated by Pandoc.

## DOCX File Structure

```
document.docx (ZIP archive)
├── [Content_Types].xml          # MIME type declarations
├── _rels/                       # Relationships to external parts
│   └── .rels
├── word/                        # Main document content
│   ├── document.xml            # Main document body with sections
│   ├── header1.xml, header2.xml, ...  # Headers
│   ├── footer1.xml, footer2.xml, ...  # Footers
│   ├── _rels/
│   │   └── document.xml.rels   # Relationships for document.xml
│   ├── styles.xml              # Style definitions
│   ├── settings.xml            # Document settings
│   ├── fontTable.xml           # Font definitions
│   └── webSettings.xml         # Web settings
└── docProps/                    # Document properties
    ├── app.xml
    └── core.xml
```

## Key XML Elements

### Document Structure

```xml
<w:document>                    # Root element
  <w:body>                      # Document body
    <w:p>                       # Paragraph
      <w:pPr>                   # Paragraph properties
        <w:sectPr>              # Section properties (defines section break)
          <w:footerReference r:id="rId10" w:type="even"/>
          <w:pgNumType w:fmt="decimal" w:start="1"/>
        </w:sectPr>
      </w:pPr>
      <w:r>                     # Run (text with same formatting)
        <w:t>Text content</w:t> # Actual text
      </w:r>
    </w:p>
  </w:body>
</w:document>
```

### Section Properties (`w:sectPr`)

```xml
<w:sectPr>
  <!-- Page numbering -->
  <w:pgNumType w:fmt="decimal" w:start="1"/>

  <!-- Section break type -->
  <w:type w:val="nextPage"/>

  <!-- Footer references -->
  <w:footerReference r:id="rId10" w:type="even"/>
  <w:footerReference r:id="rId11" w:type="default"/>
  <w:footerReference r:id="rId13" w:type="first"/>

  <!-- Page size/orientation -->
  <w:pgSz w:w="12240" w:h="15840"/>

  <!-- Page margins -->
  <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="720" w:footer="720" w:gutter="0"/>
</w:sectPr>
```

### Page Number Field in Footer

```xml
<w:ftr>
  <w:p>
    <w:r>
      <w:fldSimple w:instr="PAGE">
        <w:r>
          <w:t>- PAGE -</w:t>
        </w:r>
      </w:fldSimple>
    </w:r>
  </w:p>
</w:ftr>
```

Alternative format (more explicit):

```xml
<w:p>
  <w:r>
    <w:fldChar w:fldCharType="begin"/>
  </w:r>
  <w:r>
    <w:instrText xml:space="preserve"> PAGE </w:instrText>
  </w:r>
  <w:r>
    <w:fldChar w:fldCharType="separate"/>
  </w:r>
  <w:r>
    <w:t>1</w:t>  <!-- Display value (Word updates this) -->
  </w:r>
  <w:r>
    <w:fldChar w:fldCharType="end"/>
  </w:r>
</w:p>
```

## Python Manipulation

### Using the DocxXMLEditor

```python
import sys
from pathlib import Path

# Add docx skill to path
DOCX_SKILL = Path.home() / '.claude/plugins/cache/.../docx'
sys.path.insert(0, str(DOCX_SKILL))

from scripts.document import DocxXMLEditor

# Open document.xml
editor = DocxXMLEditor('word/document.xml', rsid="00AB1234")

# Get all section properties
sectprs = editor.dom.getElementsByTagName('w:sectPr')

# Iterate through sections
for sectpr in sectprs:
    # Check if section has page numbering type
    for child in sectpr.childNodes:
        if child.nodeType == child.ELEMENT_NODE and child.tagName == 'w:pgNumType':
            fmt = child.getAttribute('w:fmt')
            if fmt == 'lowerRoman':
                # Remove this element
                sectpr.removeChild(child)

    # Add footer reference
    editor.append_to(sectpr, '<w:footerReference r:id="rId10" w:type="even"/>')

# Save changes
editor.save()
```

### Common Operations

#### Add Element to Section

```python
# Append child to section
editor.append_to(sectpr, '<w:pgNumType w:fmt="lowerRoman"/>')
```

#### Insert Before Element

```python
# Find first element child
first_child = None
for child in sectpr.childNodes:
    if child.nodeType == child.ELEMENT_NODE:
        first_child = child
        break

# Insert before first child
if first_child:
    editor.insert_before(first_child, '<w:footerReference r:id="rId10" w:type="even"/>')
```

#### Remove Element

```python
for child in list(sectpr.childNodes):
    if child.nodeType == child.ELEMENT_NODE and child.tagName == 'w:pgNumType':
        sectpr.removeChild(child)
```

#### Check for Element Existence

```python
has_footer = any(
    child.nodeType == child.ELEMENT_NODE and
    child.tagName == 'w:footerReference'
    for child in sectpr.childNodes
)
```

## Unpacking and Packing

### Unpack DOCX

```bash
python ooxml/scripts/unpack.py document.docx output_dir
```

### Pack DOCX

```bash
python ooxml/scripts/pack.py output_dir document.docx
```

### Python Integration

```python
import subprocess
import tempfile
import shutil

temp_dir = Path(tempfile.mkdtemp())
try:
    # Unpack
    subprocess.run([
        sys.executable,
        str(unpack_script),
        str(docx_path),
        str(temp_dir)
    ], check=True, capture_output=True)

    # Process files in temp_dir

    # Pack
    subprocess.run([
        sys.executable,
        str(pack_script),
        str(temp_dir),
        str(docx_path)
    ], check=True, capture_output=True)
finally:
    shutil.rmtree(temp_dir, ignore_errors=True)
```

## Relationships (`document.xml.rels`)

Relationships link document.xml to headers, footers, and other parts:

```xml
<Relationships xmlns="...">
  <Relationship Id="rId1" Type="..." Target="styles.xml"/>
  <Relationship Id="rId10" Type="http://.../footer" Target="footer1.xml"/>
  <Relationship Id="rId11" Type="http://.../footer" Target="footer2.xml"/>
  <Relationship Id="rId13" Type="http://.../footer" Target="footer3.xml"/>
</Relationships>
```

### Finding Footer Reference IDs

```python
rels_file = temp_dir / 'word/_rels/document.xml.rels'
rels_editor = DocxXMLEditor(rels_file, rsid="00AB1234")

footer_rids = {}
for rel in rels_editor.dom.getElementsByTagName('Relationship'):
    if 'footer' in rel.getAttribute('Type'):
        rid = rel.getAttribute('Id')
        target = rel.getAttribute('Target')
        if 'footer1.xml' in target:
            footer_rids['even'] = rid
        elif 'footer2.xml' in target:
            footer_rids['default'] = rid
        elif 'footer3.xml' in target:
            footer_rids['first'] = rid
```

## Working with Bookmarks

### Bookmark in Document

```xml
<w:bookmarkStart w:id="99" w:name="_TocStart"/>
... content ...
<w:bookmarkEnd w:id="99"/>
```

### TOC Reference to Bookmark

```xml
<w:instrText xml:space="preserve"> TOC \\o "1-2" \\b "_TocStart" </w:instrText>
```

## Common Patterns

### Pattern: Count Sections with Specific Property

```python
count = 0
for sectpr in editor.dom.getElementsByTagName('w:sectPr'):
    for child in sectpr.childNodes:
        if child.nodeType == child.ELEMENT_NODE and child.tagName == 'w:pgNumType':
            if child.getAttribute('w:fmt') == 'decimal':
                count += 1
```

### Pattern: Modify Sections by Index

```python
sectprs = editor.dom.getElementsByTagName('w:sectPr')
for idx, sectpr in enumerate(sectprs):
    if idx < 2:  # Skip first 2 sections
        continue
    # Process remaining sections
```

### Pattern: Conditional Element Addition

```python
has_pgnumtype = any(
    child.nodeType == child.ELEMENT_NODE and
    child.tagName == 'w:pgNumType'
    for child in sectpr.childNodes
)

if not has_pgnumtype:
    editor.append_to(sectpr, '<w:pgNumType w:fmt="lowerRoman"/>')
```

## Important Notes

1. **RSID Attributes**: Word uses RSID (Revision Save ID) attributes for tracking changes. When editing, provide a consistent RSID like `"00AB1234"`.

2. **Node Types**: Always check `node.nodeType == node.ELEMENT_NODE` before accessing element-specific properties.

3. **Live Lists**: `childNodes` is a live list - use `list(sectpr.childNodes)` when modifying during iteration.

4. **Namespace Prefixes**: Elements use `w:` prefix (Word namespace). Ensure XML parsing preserves namespaces.

5. **Field Codes**: Page numbers use Word field codes. The `PAGE` instruction inserts current page number.

## Troubleshooting

### Issue: Changes not appearing in Word

**Cause**: Document not refreshed, field codes not updated.

**Fix**:
1. Add `<w:updateFields w:val="true"/>` to settings.xml
2. Open Word and press Ctrl+A, F9 to update all fields

### Issue: Malformed XML after editing

**Cause**: Unclosed tags, improper nesting, namespace issues.

**Fix**: Validate XML structure after each edit. Use proper XML escaping.

### Issue: Footer shows "0" or wrong number

**Cause**: Field code not properly formatted, or relationship ID incorrect.

**Fix**:
1. Verify relationship exists in document.xml.rels
2. Check footer XML has proper field code structure
3. Update fields in Word (F9)

---

## Related

- [[DOCX Page Numbering with Pandoc]]
